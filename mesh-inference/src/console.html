<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>mesh-inference</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #0a0a0a; color: #e0e0e0; min-height: 100vh; padding: 1.5rem; }
  .container { max-width: 720px; margin: 0 auto; }

  h1 { font-size: 1.2rem; font-weight: 600; display: inline; }
  .header { display: flex; align-items: baseline; gap: 0.6rem; margin-bottom: 0.15rem; }
  .subtitle { font-size: 0.75rem; color: #555; margin-bottom: 1rem; }
  h2 { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #555; margin: 1rem 0 0.4rem; }

  /* Cluster bar */
  .cluster-bar { display: flex; height: 60px; border-radius: 6px; overflow: hidden; border: 1px solid #222; }
  .cluster-node { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0.25rem 0.5rem; min-width: 80px; transition: flex 0.3s; }
  .cluster-node:not(:last-child) { border-right: 1px solid #222; }
  .node-self { background: #12202e; }
  .node-peer { background: #161622; }
  .node-empty { background: #111; flex: 1; }
  .cluster-id { font-family: monospace; font-size: 0.65rem; color: #6cf; }
  .cluster-vram { font-size: 0.6rem; color: #666; }
  .cluster-pct { font-size: 0.9rem; font-weight: 600; color: #e0e0e0; }

  /* Info row */
  .info-row { display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; flex-wrap: wrap; gap: 0.3rem; }
  .info-items { display: flex; gap: 1.2rem; flex-wrap: wrap; }
  .info-item { font-size: 0.8rem; color: #666; }
  .info-item span { color: #ccc; }
  .badge { display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.75rem; padding: 0.15rem 0.5rem; border-radius: 10px; }
  .badge .dot { width: 6px; height: 6px; border-radius: 50%; }
  .badge-green { background: #0a1a0a; color: #4c4; }
  .badge-green .dot { background: #4c4; }
  .badge-yellow { background: #1a1a0a; color: #cc4; }
  .badge-yellow .dot { background: #cc4; }
  .badge-gray { background: #151515; color: #666; }
  .badge-gray .dot { background: #555; }

  /* Token (compact inline) */
  .token-row { display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.7rem; }
  .token-preview { font-family: monospace; color: #444; font-size: 0.65rem; }
  .copy-btn { background: #1a1a1a; border: 1px solid #333; border-radius: 3px; padding: 0.1rem 0.35rem; color: #888; cursor: pointer; font-size: 0.6rem; }
  .copy-btn:hover { background: #222; color: #ccc; }

  /* Config panel (collapsible) */
  .config-panel { margin-top: 0.75rem; }
  .config-panel summary { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #444; cursor: pointer; padding: 0.3rem 0; }
  .config-panel summary:hover { color: #888; }
  .config-panel[open] summary { color: #666; }
  .config-body { padding-top: 0.4rem; }

  /* Agent commands */
  .agent-row { margin-bottom: 0.4rem; }
  .agent-label { font-size: 0.7rem; font-weight: 600; color: #555; margin-bottom: 0.1rem; }
  .agent-cmd { font-family: monospace; font-size: 0.65rem; color: #aaa; background: #080808; border: 1px solid #1a1a1a; border-radius: 4px; padding: 0.3rem 0.5rem; user-select: all; cursor: text; word-break: break-all; }
  .agent-json { font-family: monospace; font-size: 0.55rem; color: #555; margin-top: 0.2rem; }
  .agent-json summary { cursor: pointer; color: #444; text-transform: none; letter-spacing: normal; }
  .agent-json summary:hover { color: #888; }
  .agent-json pre { background: #080808; border: 1px solid #1a1a1a; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.2rem; user-select: all; cursor: text; white-space: pre-wrap; }

  /* Chat */
  .chat-area { margin-top: 0.5rem; }
  .chat-messages { min-height: 80px; max-height: 400px; overflow-y: auto; background: #080808; border: 1px solid #1a1a1a; border-radius: 4px; padding: 0.5rem; font-size: 0.85rem; line-height: 1.5; }
  .chat-messages:empty::before { content: "Type a message..."; color: #333; font-style: italic; }
  .chat-input { display: flex; gap: 0.5rem; margin-top: 0.4rem; }
  .chat-input input { flex: 1; background: #0a0a0a; border: 1px solid #333; border-radius: 4px; padding: 0.45rem 0.6rem; color: #e0e0e0; font-size: 0.85rem; }
  .chat-input input:focus { outline: none; border-color: #6cf; }
  .chat-input button { background: #1a3a5c; border: 1px solid #2a5a8c; border-radius: 4px; padding: 0.45rem 0.8rem; color: #e0e0e0; cursor: pointer; font-size: 0.8rem; }
  .chat-input button:hover { background: #2a4a6c; }
  .msg-user { color: #6cf; margin-bottom: 0.25rem; }
  .msg-bot { color: #ccc; margin-bottom: 0.5rem; white-space: pre-wrap; }
  .msg-err { color: #c66; font-size: 0.8rem; margin-bottom: 0.5rem; }
  .hidden { display: none !important; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>mesh-inference</h1>
    <span id="badge"></span>
    <span id="tokenInline" class="token-row hidden"></span>
  </div>
  <div class="subtitle" id="nodeInfo">connecting...</div>

  <div class="cluster-bar" id="clusterBar">
    <div class="node-empty" style="flex:1"></div>
  </div>

  <div class="info-row">
    <div class="info-items" id="infoItems"></div>
  </div>

  <div id="chatSection" class="hidden">
    <h2>Chat</h2>
    <div class="chat-area">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Say something..." onkeydown="if(event.key==='Enter')sendChat()">
        <button onclick="sendChat()">Send</button>
      </div>
    </div>
  </div>

  <details class="config-panel" id="configPanel">
    <summary>Config & setup ▾</summary>
    <div class="config-body">
      <div id="agentSection" class="hidden">
        <h2>Use in agents</h2>
        <div class="agent-row">
          <div class="agent-label">pi</div>
          <div class="agent-cmd" id="piCmd"></div>
          <details class="agent-json">
            <summary>~/.pi/agent/models.json snippet</summary>
            <pre id="piJson"></pre>
          </details>
        </div>
        <div class="agent-row">
          <div class="agent-label">goose</div>
          <div class="agent-cmd" id="gooseCmd"></div>
        </div>
      </div>

      <div id="tokenSection" class="hidden">
        <h2>Invite token</h2>
        <div style="font-family:monospace; font-size:0.6rem; color:#444; background:#080808; border:1px solid #1a1a1a; border-radius:4px; padding:0.3rem 0.5rem; user-select:all; cursor:text; word-break:break-all;" id="tokenFull"></div>
      </div>
    </div>
  </details>
</div>

<script>
let state = {};
const evtSource = new EventSource('/api/events');
evtSource.onmessage = (e) => { state = JSON.parse(e.data); render(); };

function render() {
  document.getElementById('nodeInfo').textContent = state.node_id
    ? `node ${state.node_id}` : 'connecting...';

  renderCluster();
  renderInfo();
  renderBadge();
  renderToken();

  const ready = state.llama_ready;
  document.getElementById('agentSection').classList.toggle('hidden', !ready);
  document.getElementById('chatSection').classList.toggle('hidden', !ready);
  if (ready) renderAgents();
}

function renderCluster() {
  const bar = document.getElementById('clusterBar');
  const nodes = [];
  if (state.node_id) {
    nodes.push({ id: state.node_id, vram: state.my_vram_gb || 0, self: true });
  }
  (state.peers || []).forEach(p => {
    nodes.push({ id: p.id, vram: p.vram_gb, self: false, role: p.role });
  });
  if (!nodes.length) {
    bar.innerHTML = '<div class="node-empty" style="flex:1"></div>';
    return;
  }
  const total = nodes.reduce((s, n) => s + n.vram, 0);
  bar.innerHTML = nodes.map(n => {
    const pct = total > 0 ? Math.round(n.vram / total * 100) : Math.round(100 / nodes.length);
    const cls = n.self ? 'node-self' : 'node-peer';
    const label = n.self ? `${n.id} (you)` : n.id;
    const pctText = nodes.length > 1 ? `${pct}%` : '';
    return `<div class="cluster-node ${cls}" style="flex:${Math.max(n.vram, 1)}">
      <div class="cluster-pct">${pctText}</div>
      <div class="cluster-id">${esc(label)}</div>
      <div class="cluster-vram">${n.vram > 0 ? n.vram.toFixed(0) + ' GB' : ''}</div>
    </div>`;
  }).join('');
}

function renderInfo() {
  const el = document.getElementById('infoItems');
  const parts = [];
  if (state.model_name) parts.push(`<span class="info-item">Model <span>${esc(state.model_name)}</span></span>`);
  if (state.draft_name) parts.push(`<span class="info-item">Draft <span>${esc(state.draft_name)}</span></span>`);
  const total = (state.my_vram_gb || 0) + (state.peers || []).reduce((s, p) => s + p.vram_gb, 0);
  if (total > 0) parts.push(`<span class="info-item">Total <span>${total.toFixed(0)} GB</span></span>`);
  if (state.llama_ready) {
    parts.push(`<span class="info-item">API <span><a href="http://localhost:${state.api_port}" style="color:#6cf;text-decoration:none">:${state.api_port}</a></span></span>`);
  }
  el.innerHTML = parts.join('');
}

function renderBadge() {
  const el = document.getElementById('badge');
  if (state.llama_ready) {
    const label = state.is_host ? 'Host' : 'Connected';
    el.innerHTML = `<span class="badge badge-green"><span class="dot"></span>${label}</span>`;
  } else if (state.is_host) {
    el.innerHTML = '<span class="badge badge-yellow"><span class="dot"></span>Loading</span>';
  } else {
    el.innerHTML = '<span class="badge badge-gray"><span class="dot"></span>Waiting</span>';
  }
}

function renderToken() {
  const inl = document.getElementById('tokenInline');
  const full = document.getElementById('tokenSection');
  if (state.token) {
    inl.classList.remove('hidden');
    inl.innerHTML = `<span class="token-preview">${state.token.slice(0, 12)}…</span><button class="copy-btn" onclick="copyToken()">copy token</button>`;
    full.classList.remove('hidden');
    document.getElementById('tokenFull').textContent = state.token;
  } else {
    inl.classList.add('hidden');
    full.classList.add('hidden');
  }
}

function copyToken() {
  navigator.clipboard.writeText(state.token).then(() => {
    const btn = document.querySelector('#tokenInline .copy-btn');
    btn.textContent = '✓ copied';
    setTimeout(() => { btn.textContent = 'copy token'; }, 2000);
  });
}

function renderAgents() {
  const model = state.model_name || 'model';
  const port = state.api_port || 9337;
  document.getElementById('piCmd').textContent = state.launch_pi || `pi --provider mesh --model ${model}`;
  document.getElementById('gooseCmd').textContent = state.launch_goose || `GOOSE_PROVIDER=openai OPENAI_HOST=http://localhost:${port} OPENAI_API_KEY=mesh GOOSE_MODEL=${model} goose session`;
  document.getElementById('piJson').textContent = JSON.stringify({
    mesh: { baseUrl: `http://localhost:${port}/v1`, api: "openai-completions", apiKey: "mesh",
      models: [{ id: model, name: model, reasoning: false, input: ["text"], contextWindow: 32768, maxTokens: 8192,
        compat: { supportsUsageInStreaming: false, maxTokensField: "max_tokens", supportsDeveloperRole: false } }] }
  }, null, 2);
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  const messages = document.getElementById('chatMessages');
  messages.innerHTML += `<div class="msg-user">› ${esc(msg)}</div>`;
  const botDiv = document.createElement('div');
  botDiv.className = 'msg-bot';
  messages.appendChild(botDiv);
  messages.scrollTop = messages.scrollHeight;
  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: 'test', messages: [{ role: 'user', content: msg }], stream: true }),
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const d = line.slice(6).trim();
        if (d === '[DONE]') continue;
        try {
          const chunk = JSON.parse(d);
          const text = chunk.choices?.[0]?.delta?.content || chunk.choices?.[0]?.delta?.reasoning_content || '';
          if (text) { botDiv.textContent += text; messages.scrollTop = messages.scrollHeight; }
        } catch {}
      }
    }
    if (!botDiv.textContent) botDiv.textContent = '(empty response)';
  } catch (e) {
    botDiv.remove();
    messages.innerHTML += `<div class="msg-err">Error: ${esc(e.message)}</div>`;
  }
  messages.scrollTop = messages.scrollHeight;
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

fetch('/api/status').then(r => r.json()).then(d => { state = d; render(); });
</script>
</body>
</html>
