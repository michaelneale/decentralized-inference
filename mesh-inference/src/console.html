<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>mesh-inference</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #0a0a0a; color: #e0e0e0; min-height: 100vh; padding: 2rem; }
  .container { max-width: 640px; margin: 0 auto; }
  h1 { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem; }
  .subtitle { font-size: 0.8rem; color: #555; margin-bottom: 1rem; }
  h2 { font-size: 1rem; font-weight: 500; color: #888; margin: 1.5rem 0 0.5rem; }
  .hidden { display: none !important; }

  .node-id { font-family: monospace; color: #6cf; font-size: 0.85rem; }
  .token-row { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.3rem; }
  .token-label { font-size: 0.8rem; color: #666; }
  .token-preview { font-family: monospace; font-size: 0.75rem; color: #555; }
  .copy-btn { background: #1a1a1a; border: 1px solid #333; border-radius: 4px; padding: 0.2rem 0.5rem; color: #aaa; cursor: pointer; font-size: 0.75rem; white-space: nowrap; }
  .copy-btn:hover { background: #222; color: #e0e0e0; }
  .copy-btn.copied { color: #6f6; border-color: #4a4; }

  .section { background: #111; border: 1px solid #222; border-radius: 6px; padding: 0.75rem 1rem; margin: 0.5rem 0; }

  .join-row { display: flex; gap: 0.5rem; }
  .join-row input { flex: 1; background: #0a0a0a; border: 1px solid #333; border-radius: 4px; padding: 0.4rem 0.6rem; color: #e0e0e0; font-family: monospace; font-size: 0.8rem; }
  .join-row input:focus { outline: none; border-color: #6cf; }

  .peer-row { display: flex; justify-content: space-between; align-items: center; padding: 0.3rem 0; }
  .peer-row + .peer-row { border-top: 1px solid #1a1a1a; }
  .peer-id { font-family: monospace; color: #6cf; font-size: 0.85rem; }
  .peer-role { font-size: 0.8rem; color: #888; }
  .no-peers { color: #444; font-size: 0.85rem; }

  .choices { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; margin: 0.75rem 0; }
  .choice { background: #111; border: 2px solid #222; border-radius: 8px; padding: 1rem 0.75rem; cursor: pointer; text-align: center; transition: all 0.15s; }
  .choice:hover { border-color: #444; background: #151515; }
  .choice.active { border-color: #6cf; background: #0c1a2a; }
  .choice.disabled { opacity: 0.35; pointer-events: none; }
  .choice-icon { font-size: 1.8rem; margin-bottom: 0.4rem; }
  .choice-title { font-weight: 600; font-size: 0.9rem; }
  .choice-desc { font-size: 0.7rem; color: #666; margin-top: 0.3rem; line-height: 1.3; }

  button { background: #222; border: 1px solid #444; border-radius: 4px; padding: 0.4rem 0.8rem; color: #e0e0e0; cursor: pointer; font-size: 0.85rem; transition: all 0.15s; }
  button:hover { background: #333; }
  button:disabled { opacity: 0.4; cursor: default; }
  .btn-primary { background: #1a3a5c; border-color: #2a5a8c; }
  .btn-primary:hover:not(:disabled) { background: #2a4a6c; }
  .btn-stop { background: #2a1515; border-color: #442222; color: #c88; font-size: 0.8rem; padding: 0.3rem 0.6rem; }
  .btn-stop:hover { background: #3a2020; }

  select { background: #0a0a0a; border: 1px solid #333; border-radius: 4px; padding: 0.4rem 0.6rem; color: #e0e0e0; font-size: 0.85rem; width: 100%; }

  .status-line { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; }
  .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
  .dot-green { background: #4c4; }
  .dot-yellow { background: #cc4; }
  .dot-blue { background: #6cf; }

  .progress-bar { width: 100%; height: 4px; background: #222; border-radius: 2px; overflow: hidden; margin: 0.4rem 0; }
  .progress-fill { height: 100%; background: #6cf; transition: width 0.3s; }

  .chat-area { margin-top: 0.5rem; }
  .chat-messages { min-height: 60px; max-height: 300px; overflow-y: auto; background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 4px; padding: 0.5rem; margin-bottom: 0.5rem; font-size: 0.85rem; line-height: 1.5; }
  .chat-messages:empty::before { content: "Type a message to test the API..."; color: #333; font-style: italic; }
  .chat-input { display: flex; gap: 0.5rem; }
  .chat-input input { flex: 1; background: #0a0a0a; border: 1px solid #333; border-radius: 4px; padding: 0.5rem 0.75rem; color: #e0e0e0; font-size: 0.9rem; }
  .chat-input input:focus { outline: none; border-color: #6cf; }
  .msg-user { color: #6cf; margin-bottom: 0.25rem; }
  .msg-bot { color: #ccc; margin-bottom: 0.5rem; white-space: pre-wrap; }
  .msg-err { color: #c66; font-size: 0.8rem; margin-bottom: 0.5rem; }
  .msg-thinking { color: #555; font-style: italic; }

  .api-hint { font-family: monospace; font-size: 0.7rem; color: #444; background: #080808; border: 1px solid #1a1a1a; border-radius: 4px; padding: 0.4rem 0.5rem; margin-bottom: 0.5rem; white-space: pre-wrap; word-break: break-all; }
  .warning { color: #cc4; font-size: 0.8rem; margin: 0.3rem 0; }
  .detail { font-size: 0.85rem; color: #888; margin-top: 0.4rem; line-height: 1.6; }
  .detail a { color: #6cf; text-decoration: none; }
</style>
</head>
<body>
<div class="container">
  <h1>mesh-inference</h1>
  <div class="subtitle" id="nodeInfo">starting...</div>

  <!-- Mesh: join + token + peers â€” always visible -->
  <div class="section" id="meshSection">
    <div class="join-row">
      <input type="text" id="joinToken" placeholder="Paste an invite token to join...">
      <button onclick="joinMesh()" class="btn-primary">Join</button>
    </div>
    <div id="tokenRow" class="token-row hidden">
      <span class="token-label">Your token:</span>
      <span class="token-preview" id="tokenPreview"></span>
      <button class="copy-btn" id="copyBtn" onclick="copyToken()">ðŸ“‹ Copy</button>
      <span id="tokenFull" style="display:none;"></span>
    </div>
    <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #1a1a1a;">
      <div id="thisNode" class="peer-row" style="opacity: 0.6;"></div>
      <div id="peersList"></div>
    </div>
  </div>

  <!-- Role selection (hidden when active) -->
  <div id="roleSection">
    <h2>What do you want to do?</h2>
    <div class="choices">
      <div class="choice" id="choiceGpu" onclick="selectRole('share_gpu')">
        <div class="choice-icon">ðŸ–¥</div>
        <div class="choice-title">Share GPU</div>
        <div class="choice-desc">Contribute compute to the mesh. Needs model file.</div>
      </div>
      <div class="choice" id="choiceLlm" onclick="selectRole('run_llm')">
        <div class="choice-icon">ðŸ§ </div>
        <div class="choice-title">Run LLM</div>
        <div class="choice-desc">Run an LLM on your GPU (+ mesh workers). Serves an API.</div>
      </div>
      <div class="choice" id="choiceConnect" onclick="selectRole('just_connect')">
        <div class="choice-icon">ðŸ’¬</div>
        <div class="choice-title">Just Connect</div>
        <div class="choice-desc">Use someone else's LLM. No GPU or model needed.</div>
      </div>
    </div>
  </div>

  <!-- Share GPU config -->
  <div id="gpuConfig" class="section hidden">
    <div style="margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem;">Select model:</div>
    <select id="gpuModelSelect"></select>
    <div id="gpuNoModel" class="warning hidden">No models found in ~/.models/</div>
    <div id="gpuDownloadRow" class="hidden" style="margin-top: 0.5rem;">
      <button onclick="downloadModel()" class="btn-primary">Download GLM-4.7-Flash (17GB)</button>
    </div>
    <button onclick="startShareGpu()" class="btn-primary" style="margin-top: 0.75rem; width: 100%;" id="gpuStartBtn">Start sharing GPU</button>
    <div id="gpuNoBins" class="warning hidden">âš  llama.cpp binaries not found</div>
  </div>

  <!-- Run LLM config -->
  <div id="llmConfig" class="section hidden">
    <div style="margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem;">Select model:</div>
    <select id="llmModelSelect"></select>
    <div id="llmNoModel" class="warning hidden">No models found in ~/.models/</div>
    <div id="llmDownloadRow" class="hidden" style="margin-top: 0.5rem;">
      <button onclick="downloadModel()" class="btn-primary">Download GLM-4.7-Flash (17GB)</button>
    </div>
    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; align-items: center;">
      <label style="font-size: 0.85rem; color: #888;">Port:</label>
      <input type="number" id="llmPort" value="8090" style="width: 70px; background: #0a0a0a; border: 1px solid #333; border-radius: 4px; padding: 0.3rem 0.5rem; color: #e0e0e0; font-size: 0.85rem;">
    </div>
    <button onclick="startRunLlm()" class="btn-primary" style="margin-top: 0.75rem; width: 100%;" id="llmStartBtn">Start LLM</button>
    <div id="llmNoBins" class="warning hidden">âš  llama.cpp binaries not found</div>
  </div>

  <!-- Download progress (shared) -->
  <div id="downloadProgress" class="section hidden">
    <div style="font-size: 0.85rem;">Downloading model...</div>
    <div class="progress-bar"><div class="progress-fill" id="downloadFill"></div></div>
    <div id="downloadSize" style="font-size: 0.8rem; color: #666;"></div>
  </div>

  <!-- Active status -->
  <div id="activeStatus" class="section hidden">
    <div class="status-line">
      <span class="dot" id="statusDot"></span>
      <span id="statusText"></span>
      <span style="flex:1"></span>
      <button class="btn-stop" onclick="stopAll()">Stop</button>
    </div>
    <div class="detail" id="statusDetail"></div>
  </div>

  <!-- Chat (for Run LLM and Just Connect) -->
  <div id="chatSection" class="hidden">
    <h2>Try it</h2>
    <div id="apiHint" class="api-hint"></div>
    <div class="chat-area">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Say something..." onkeydown="if(event.key==='Enter')sendChat()">
        <button onclick="sendChat()" class="btn-primary" id="chatSendBtn">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
let state = {};
let selectedRole = null;

const evtSource = new EventSource('/api/events');
evtSource.onmessage = (e) => { state = JSON.parse(e.data); render(); };

function render() {
  // Node info
  const info = document.getElementById('nodeInfo');
  info.textContent = state.node_id ? `node ${state.node_id}` : 'starting...';

  // Token
  const tokenRow = document.getElementById('tokenRow');
  if (state.token) {
    tokenRow.classList.remove('hidden');
    document.getElementById('tokenFull').textContent = state.token;
    document.getElementById('tokenPreview').textContent = state.token.slice(0, 16) + 'â€¦';
  }

  // This node
  const thisNode = document.getElementById('thisNode');
  if (state.node_id) {
    const model = state.model_name ? ` Â· ${state.model_name}` : '';
    thisNode.innerHTML = `<span class="peer-id">${state.node_id} (you)</span><span class="peer-role">${state.role_label}${model}</span>`;
  }

  // Peers
  const peersList = document.getElementById('peersList');
  if (state.peers && state.peers.length > 0) {
    peersList.innerHTML = state.peers.map(p => {
      const models = p.models && p.models.length > 0 ? ` Â· ${p.models.join(', ')}` : '';
      return `<div class="peer-row"><span class="peer-id">${p.id}</span><span class="peer-role">${p.role}${models}</span></div>`;
    }).join('');
  } else {
    peersList.innerHTML = '';
  }

  // Model selects
  populateModelSelect('gpuModelSelect', 'gpuNoModel', 'gpuDownloadRow');
  populateModelSelect('llmModelSelect', 'llmNoModel', 'llmDownloadRow');

  // Binary warnings
  document.getElementById('gpuNoBins').classList.toggle('hidden', !!state.has_binaries);
  document.getElementById('llmNoBins').classList.toggle('hidden', !!state.has_binaries);
  document.getElementById('gpuStartBtn').disabled = !state.has_binaries;
  document.getElementById('llmStartBtn').disabled = !state.has_binaries;

  // Download progress
  const dp = document.getElementById('downloadProgress');
  if (state.download) {
    dp.classList.remove('hidden');
    const mb = (state.download.downloaded / 1048576).toFixed(0);
    document.getElementById('downloadFill').style.width = state.download.total
      ? (state.download.downloaded / state.download.total * 100) + '%' : '0%';
    document.getElementById('downloadSize').textContent = `${mb} MB downloaded...`;
  } else {
    dp.classList.add('hidden');
  }

  // Active state
  const isActive = state.role && state.role !== 'idle';
  document.getElementById('roleSection').classList.toggle('hidden', isActive);
  document.getElementById('gpuConfig').classList.toggle('hidden', isActive || selectedRole !== 'share_gpu');
  document.getElementById('llmConfig').classList.toggle('hidden', isActive || selectedRole !== 'run_llm');

  const activeEl = document.getElementById('activeStatus');
  const chatEl = document.getElementById('chatSection');
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  const detail = document.getElementById('statusDetail');

  if (state.role === 'share_gpu') {
    activeEl.classList.remove('hidden');
    dot.className = 'dot dot-green';
    text.textContent = 'Sharing GPU';
    const model = state.model_path ? state.model_path.split('/').pop() : '';
    detail.innerHTML = model ? `Model: ${model}<br>Waiting for someone to orchestrate...` : 'rpc-server running';
    chatEl.classList.add('hidden');

  } else if (state.role === 'run_llm') {
    activeEl.classList.remove('hidden');
    if (state.llama_ready) {
      dot.className = 'dot dot-green';
      text.textContent = 'LLM running';
      const port = state.llama_port || 8090;
      const model = state.model_name ? `${state.model_name} Â· ` : '';
      detail.innerHTML = `${model}<a href="http://localhost:${port}" target="_blank">http://localhost:${port}</a>`;
      chatEl.classList.remove('hidden');
      document.getElementById('apiHint').textContent =
        `curl http://localhost:${port}/v1/chat/completions \\\n  -H 'Content-Type: application/json' \\\n  -d '{"model":"test","messages":[{"role":"user","content":"Hello!"}]}'`;
    } else {
      dot.className = 'dot dot-yellow';
      text.textContent = 'Loading model...';
      detail.textContent = 'Starting llama-server, this takes a few seconds...';
      chatEl.classList.add('hidden');
    }

  } else if (state.role === 'just_connect') {
    activeEl.classList.remove('hidden');
    const port = state.client_port || 8080;
    dot.className = 'dot dot-blue';
    text.textContent = 'Connected';
    detail.innerHTML = `<a href="http://localhost:${port}" target="_blank">http://localhost:${port}</a>`;
    chatEl.classList.remove('hidden');
    document.getElementById('apiHint').textContent =
      `curl http://localhost:${port}/v1/chat/completions \\\n  -H 'Content-Type: application/json' \\\n  -d '{"model":"test","messages":[{"role":"user","content":"Hello!"}]}'`;

  } else {
    activeEl.classList.add('hidden');
    chatEl.classList.add('hidden');
  }

  // "Just Connect" only if a host exists
  const hasHost = state.peers && state.peers.some(p => p.role.includes('Host'));
  document.getElementById('choiceConnect').classList.toggle('disabled', !hasHost);
}

function populateModelSelect(selectId, noModelId, downloadRowId) {
  const sel = document.getElementById(selectId);
  const noModel = document.getElementById(noModelId);
  const dlRow = document.getElementById(downloadRowId);
  if (state.models && state.models.length > 0) {
    const prev = sel.value;
    sel.innerHTML = state.models.map(m =>
      `<option value="${m.path}">${m.name} (${m.size})</option>`
    ).join('');
    if (prev) sel.value = prev;
    sel.classList.remove('hidden');
    noModel.classList.add('hidden');
    dlRow.classList.add('hidden');
  } else {
    sel.innerHTML = '';
    sel.classList.add('hidden');
    noModel.classList.remove('hidden');
    dlRow.classList.remove('hidden');
  }
}

function selectRole(role) {
  selectedRole = role;
  document.querySelectorAll('.choice').forEach(c => c.classList.remove('active'));
  if (role === 'share_gpu') {
    document.getElementById('choiceGpu').classList.add('active');
  } else if (role === 'run_llm') {
    document.getElementById('choiceLlm').classList.add('active');
  } else if (role === 'just_connect') {
    document.getElementById('choiceConnect').classList.add('active');
    startJustConnect();
    return;
  }
  render();
}

async function joinMesh() {
  const input = document.getElementById('joinToken');
  const token = input.value.trim();
  if (!token) return;
  const res = await fetch('/api/join', { method: 'POST', body: token });
  const data = await res.json();
  if (data.ok) { input.value = ''; } else { alert(data.error || 'Failed to join'); }
}

async function downloadModel() { await fetch('/api/download-model', { method: 'POST' }); }

async function startShareGpu() {
  const model = document.getElementById('gpuModelSelect').value;
  if (!model) return alert('Select a model first');
  const res = await fetch('/api/share-gpu', { method: 'POST', body: JSON.stringify({ model }) });
  const data = await res.json();
  if (!data.ok) alert(data.error || 'Failed');
}

async function startRunLlm() {
  const model = document.getElementById('llmModelSelect').value;
  const port = parseInt(document.getElementById('llmPort').value) || 8090;
  if (!model) return alert('Select a model first');
  const res = await fetch('/api/run-llm', { method: 'POST', body: JSON.stringify({ model, port }) });
  const data = await res.json();
  if (!data.ok) alert(data.error || 'Failed');
}

async function startJustConnect() {
  const res = await fetch('/api/just-connect', { method: 'POST' });
  const data = await res.json();
  if (!data.ok) { alert(data.error || 'Failed'); selectedRole = null; render(); }
}

async function stopAll() {
  await fetch('/api/stop', { method: 'POST' });
  selectedRole = null;
  document.getElementById('chatMessages').innerHTML = '';
}

function copyToken() {
  const full = document.getElementById('tokenFull').textContent;
  const btn = document.getElementById('copyBtn');
  navigator.clipboard.writeText(full).then(() => {
    btn.textContent = 'âœ“ Copied';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'ðŸ“‹ Copy'; btn.classList.remove('copied'); }, 2000);
  });
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';

  const port = state.llama_port || state.client_port || 8090;
  const messages = document.getElementById('chatMessages');
  messages.innerHTML += `<div class="msg-user">â€º ${escHtml(msg)}</div>`;

  const botDiv = document.createElement('div');
  botDiv.className = 'msg-bot';
  botDiv.textContent = '';
  messages.appendChild(botDiv);
  messages.scrollTop = messages.scrollHeight;

  try {
    const res = await fetch(`http://localhost:${port}/v1/chat/completions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: 'test', messages: [{ role: 'user', content: msg }], stream: true }),
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const d = line.slice(6).trim();
        if (d === '[DONE]') continue;
        try {
          const chunk = JSON.parse(d);
          const delta = chunk.choices?.[0]?.delta;
          // GLM puts thinking in reasoning_content, answer in content
          const text = delta?.content || delta?.reasoning_content || '';
          if (text) {
            botDiv.textContent += text;
            messages.scrollTop = messages.scrollHeight;
          }
        } catch {}
      }
    }
    if (!botDiv.textContent) botDiv.textContent = '(empty response)';
  } catch (e) {
    botDiv.remove();
    messages.innerHTML += `<div class="msg-err">Error: ${escHtml(e.message)}</div>`;
  }
  messages.scrollTop = messages.scrollHeight;
}

function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

fetch('/api/status').then(r => r.json()).then(d => { state = d; render(); });
</script>
</body>
</html>
